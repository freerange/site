<VirtualHost *:80>
  ServerName gofreerange.com
  ServerAlias www.gofreerange.com

  ###########################################
  # REDIRECTS
  ###########################################

  RewriteEngine On

  RewriteCond %{SERVER_NAME} =www.gofreerange.com [OR]
  RewriteCond %{SERVER_NAME} =gofreerange.com
  RewriteRule ^ https://%{SERVER_NAME}%{REQUEST_URI} [END,NE,R=permanent]
</VirtualHost>

<VirtualHost *:443>
  ServerName www.gofreerange.com

  ###########################################
  # SSL
  ###########################################

  SSLCertificateFile /etc/letsencrypt/live/www.gofreerange.com/cert.pem
  SSLCertificateKeyFile /etc/letsencrypt/live/www.gofreerange.com/privkey.pem
  Include /etc/letsencrypt/options-ssl-apache.conf
  SSLCertificateChainFile /etc/letsencrypt/live/www.gofreerange.com/chain.pem

  ###########################################
  # REDIRECTS
  ###########################################

  RewriteEngine On

  # Remove www. at the start of hostname
  RewriteCond %{HTTP_HOST} ^www.gofreerange.com$ [NC]
  RewriteRule ^/(.*)$ https://gofreerange.com/$1 [R=301,L]
</VirtualHost>

<VirtualHost *:443>
  ServerName gofreerange.com

  PassengerUser freerange

  DocumentRoot /home/freerange/app/public
  RackEnv production

  ###########################################
  # SSL
  ###########################################

  SSLCertificateFile /etc/letsencrypt/live/gofreerange.com/cert.pem
  SSLCertificateKeyFile /etc/letsencrypt/live/gofreerange.com/privkey.pem
  Include /etc/letsencrypt/options-ssl-apache.conf
  SSLCertificateChainFile /etc/letsencrypt/live/gofreerange.com/chain.pem

  ###########################################
  # EXPIRES
  ###########################################

  # Far-future Expires Header
  # Ref: http://guides.rubyonrails.org/v5.1.2/asset_pipeline.html#far-future-expires-header

  <Location /assets/>
    # Use of ETag is discouraged when Last-Modified is present
    Header unset ETag
    FileETag None
    # RFC says only cache for 1 year
    ExpiresActive On
    ExpiresDefault "access plus 1 year"
  </Location>

  # Ref: http://httpd.apache.org/docs/2.2/mod/mod_expires.html
  # Ref: http://api.rubyonrails.org/classes/ActionView/Helpers/AssetTagHelper.html

  ExpiresActive On
  <FilesMatch "\.(ico|gif|jpe?g|png|js|css)$">
    ExpiresDefault "access plus 1 week"
  </FilesMatch>

  ###########################################
  # DIRECTORY OPTIONS & PERMISSIONS
  ###########################################

  AliasMatch ^/mocha/docs(.*)$ /home/freerange/docs/mocha$1
  <Directory "/home/freerange/docs/mocha">
    PassengerEnabled off
    AllowOverride all
    Require all granted
    Options +Indexes
  </Directory>

  <Directory "/home/freerange/app/public">
    Options +Indexes
    Require all granted
  </Directory>

  ###########################################
  # REDIRECTS
  ###########################################

  RewriteEngine On

  # Check for maintenance file and redirect all requests
  RewriteCond %{DOCUMENT_ROOT}/system/maintenance.html -f
  RewriteCond %{SCRIPT_FILENAME} !maintenance.html
  RewriteRule ^.*$ /system/maintenance.html [L]

  # Redirect paths missing slash after `docs`
  RewriteRule ^/mocha/docs([^\/].*)$ /mocha/docs/$1 [R=301,L]

  # Redirect Rdoc-based paths to Yard-based paths
  RewriteRule ^/mocha/docs/classes/$ /mocha/docs/ [R=301,L]
  RewriteRule ^/mocha/docs/classes/(.+)$ /mocha/docs/$1 [R=301,L]

  RewriteRule ^/mocha/docs/(.+)\.src.*$ /mocha/docs/$1.html [R=301,L]

  RewriteRule ^/mocha/docs/fr_class_index\.html$ /mocha/docs/class_list.html [R=301,L]
  RewriteRule ^/mocha/docs/fr_file_index\.html$ /mocha/docs/file_list.html [R=301,L]
  RewriteRule ^/mocha/docs/fr_method_index\.html$ /mocha/docs/method_list.html [R=301,L]

  RewriteRule ^/mocha/docs/files/$ /mocha/docs/file_list.html [R=301,L]
  RewriteRule ^/mocha/docs/files/(.+)$ /mocha/docs/file.$1 [R=301,L]

  RewriteRule ^/mocha/docs/(.+)_rdoc\.html$ /mocha/docs/file.$1.html [R=301,L]

  RewriteRule ^/mocha/docs/file.mocha.html$ /mocha/docs/ [R=301,L]
  RewriteRule ^/mocha/docs/file.stubba.html$ /mocha/docs/ [R=301,L]
  RewriteRule ^/mocha/docs/file.misc.html$ /mocha/docs/ [R=301,L]

  # Redirect legacy Mocha docs to most relevant existing docs
  RewriteRule ^/mocha/docs/Object\.html$ /mocha/docs/Mocha/ObjectMethods.html [R=301,L]
  RewriteRule ^/mocha/docs/Class\.html$ /mocha/docs/Mocha/ClassMethods.html [R=301,L]
  RewriteRule ^/mocha/docs/Mocha/AutoVerify.html$ /mocha/docs/Mocha/API.html [R=301,L]
</VirtualHost>
